!function(t,e){var r={};t.fn.tableDrag=function(e){e=t.extend({draggableClass:"draggable",cookiePath:"/",group:{fieldClass:"row-depth",depthLimit:3},weight:{fieldClass:"row-weight",hidden:!0},parent:{fieldClass:"row-parent",sourceFieldClass:"person-id",hidden:!0},rtl:!1},e||{}),this.each(function(){e.rtl&&t(this).addClass("tabledrag-rtl");new r.tableDrag(this,e);t("tr."+e.draggableClass,this).each(function(){var a=t(this);if(e.group.fieldClass){var n=t("."+e.group.fieldClass,a);if(n.length)for(var i=1,s=n.val();s>i;i++)t("td:first",a).prepend(r.theme("tableDragIndentation"))}})})},r.tableDrag=function(e,a){var n=this;if(this.table=e,this.$table=t(e),this.tableSettings=a,this.dragObject=null,this.rowObject=null,this.oldRowElement=null,this.oldY=0,this.changed=!1,this.maxDepth=0,this.rtl="rtl"==t(this.table).css("direction")?-1:1,this.scrollSettings={amount:4,interval:50,trigger:70},this.scrollInterval=null,this.scrollY=0,this.windowHeight=0,this.indentEnabled=!!a.parent.fieldClass,this.maxDepth=this.indentEnabled?a.group.depthLimit:this.maxDepth,this.indentEnabled){this.indentCount=1;var i=r.theme("tableDragIndentation"),s=t("<tr/>").addClass(this.tableSettings.draggableClass).appendTo(e),o=t("<td/>").appendTo(s).prepend(i).prepend(i);this.indentAmount=t(".indentation",o).get(1).offsetLeft-t(".indentation",o).get(0).offsetLeft,s.remove()}t("> tr."+this.tableSettings.draggableClass+", > tbody > tr."+this.tableSettings.draggableClass,e).each(function(){n.makeDraggable(this)}),this.$table.before(t('<a href="#" class="tabledrag-toggle-weight"></a>').attr("title",r.t("Re-order rows by numerical weight/parent instead of dragging.")).click(function(){return 1==t.cookie("Drupal.tableDrag.showWeight")?n.hideColumns():n.showColumns(),!1}).wrap('<div class="tabledrag-toggle-weight-wrapper"></div>').parent()),n.initColumns(),t(document).bind("mousemove",function(t){return n.dragRow(t,n)}),t(document).bind("mouseup",function(t){return n.dropRow(t,n)})},r.tableDrag.prototype.initColumns=function(){for(var r in{group:1,weight:1,parent:1}){if(this.tableSettings[r].fieldClass!==e){var a=t("."+this.tableSettings[r].fieldClass+":first",this.table);if(a.length&&this.tableSettings[r].hidden)var n=this.tableSettings[r].hidden,i=a.closest("td")}if(n&&i[0]){var s=t("> td",i.parent()).index(i.get(0))+1;t("> thead > tr, > tbody > tr, > tr",this.table).each(function(){var e=s,r=t(this).children();r.each(function(t){e>t&&this.colSpan&&this.colSpan>1&&(e-=this.colSpan-1)}),e>0&&(i=r.filter(":nth-child("+e+")"),i.addClass(i[0].colSpan&&i[0].colSpan>1?"tabledrag-has-colspan":"tabledrag-hide"))})}}null===t.cookie("Drupal.tableDrag.showWeight")?(t.cookie("Drupal.tableDrag.showWeight",0,{path:this.tableSettings.cookiePath,expires:365}),this.hideColumns()):1==t.cookie("Drupal.tableDrag.showWeight")?this.showColumns():this.hideColumns()},r.tableDrag.prototype.hideColumns=function(){t(".tabledrag-hide",this.table).css("display","none"),t(".tabledrag-handle",this.table).css("display",""),t(".tabledrag-has-colspan",this.table).each(function(){this.colSpan=this.colSpan-1}),t(".tabledrag-toggle-weight").text(r.t("Show row weights/parents")),t.cookie("Drupal.tableDrag.showWeight",0,{path:this.tableSettings.cookiePath,expires:365}),t(this.table).trigger("columnschange","hide")},r.tableDrag.prototype.showColumns=function(){t(".tabledrag-hide",this.table).css("display",""),t(".tabledrag-handle",this.table).css("display","none"),t(".tabledrag-has-colspan",this.table).each(function(){this.colSpan=this.colSpan+1}),t(".tabledrag-toggle-weight").text(r.t("Hide row weights/parents")),t.cookie("Drupal.tableDrag.showWeight",1,{path:this.tableSettings.cookiePath,expires:365}),t(this.table).trigger("columnschange","show")},r.tableDrag.prototype.rowSettings=function(r,a){if(this.tableSettings[r].fieldClass!==e){var n=t("."+this.tableSettings[r].fieldClass,a);if(n.length){var i=this.tableSettings[r];return i.relationship="group"==r?"group":"parent"==r?"parent":"weight"==r?"sibling":"self",i.action="group"==r?"depth":"parent"==r?"match":"weight"==r?"order":"order",i}}},r.tableDrag.prototype.makeDraggable=function(e){var a=this,n=t('<a href="#" class="tabledrag-handle"><div class="handle">&nbsp;</div></a>').attr("title",r.t("Drag to re-order"));t("td:first .indentation:last",e).length?(t("td:first .indentation:last",e).after(n),a.indentCount=Math.max(t(".indentation",e).length,a.indentCount)):t("td:first",e).prepend(n),n.hover(function(){null==a.dragObject?t(this).addClass("tabledrag-handle-hover"):null},function(){null==a.dragObject?t(this).removeClass("tabledrag-handle-hover"):null}),n.mousedown(function(r){return a.dragObject={},a.dragObject.initMouseOffset=a.getMouseOffset(e,r),a.dragObject.initMouseCoords=a.mouseCoords(r),a.indentEnabled&&(a.dragObject.indentMousePos=a.dragObject.initMouseCoords),a.rowObject&&t("a.tabledrag-handle",a.rowObject.element).blur(),a.rowObject=new a.row(e,"mouse",a.indentEnabled,a.maxDepth,!0,a.tableSettings.draggableClass),a.table.topY=t(a.table).offset().top,a.table.bottomY=a.table.topY+a.table.offsetHeight,t(this).addClass("tabledrag-handle-hover"),t(e).addClass("drag"),t("body").addClass("drag"),a.oldRowElement&&t(a.oldRowElement).removeClass("drag-previous"),-1!=navigator.userAgent.indexOf("MSIE 6.")&&t("select",this.table).css("display","none"),a.safeBlur=!1,a.onDrag(),!1}),n.click(function(){return!1}),n.focus(function(){t(this).addClass("tabledrag-handle-hover"),a.safeBlur=!0}),n.blur(function(e){t(this).removeClass("tabledrag-handle-hover"),a.rowObject&&a.safeBlur&&a.dropRow(e,a)}),n.keydown(function(r){9==r.keyCode||a.rowObject||(a.rowObject=new a.row(e,"keyboard",a.indentEnabled,a.maxDepth,!0,a.tableSettings.draggableClass));var i=!1;switch(r.keyCode){case 37:case 63234:i=!0,a.rowObject.indent(-1*a.rtl);break;case 38:case 63232:for(var s=t(a.rowObject.element).prev("tr").get(0);s&&t(s).is(":hidden");)s=t(s).prev("tr").get(0);if(s){if(a.safeBlur=!1,a.rowObject.direction="up",i=!0,t(e).is(".tabledrag-root")){for(var o=0;s&&t(".indentation",s).length;)s=t(s).prev("tr").get(0),o+=t(s).is(":hidden")?0:s.offsetHeight;s&&(a.rowObject.swap("before",s),window.scrollBy(0,-o))}else(a.table.tBodies[0].rows[0]!=s||t(s).is("."+a.tableSettings.draggableClass))&&(a.rowObject.swap("before",s),a.rowObject.interval=null,a.rowObject.indent(0),window.scrollBy(0,-parseInt(e.offsetHeight,10)));n.get(0).focus()}break;case 39:case 63235:i=!0,a.rowObject.indent(1*a.rtl);break;case 40:case 63233:for(var l=t(a.rowObject.group).filter(":last").next("tr").get(0);l&&t(l).is(":hidden");)l=t(l).next("tr").get(0);if(l){if(a.safeBlur=!1,a.rowObject.direction="down",i=!0,t(e).is(".tabledrag-root")){var o=0,d=new a.row(l,"keyboard",a.indentEnabled,a.maxDepth,!1,a.tableSettings.draggableClass);if(d){t(d.group).each(function(){o+=t(this).is(":hidden")?0:this.offsetHeight});var h=t(d.group).filter(":last").get(0);a.rowObject.swap("after",h),window.scrollBy(0,parseInt(o,10))}}else a.rowObject.swap("after",l),a.rowObject.interval=null,a.rowObject.indent(0),window.scrollBy(0,parseInt(e.offsetHeight,10));n.get(0).focus()}}return a.rowObject&&1==a.rowObject.changed&&(t(e).addClass("drag"),a.oldRowElement&&t(a.oldRowElement).removeClass("drag-previous"),a.oldRowElement=e,a.restripeTable(),a.onDrag()),i?!1:void 0}),n.keypress(function(t){switch(t.keyCode){case 37:case 38:case 39:case 40:return!1}})},r.tableDrag.prototype.dragRow=function(t,e){if(e.dragObject){e.currentMouseCoords=e.mouseCoords(t);var r=e.currentMouseCoords.y-e.dragObject.initMouseOffset.y,a=e.currentMouseCoords.x-e.dragObject.initMouseOffset.x;if(r!=e.oldY){e.rowObject.direction=r>e.oldY?"down":"up",e.oldY=r;var n=e.checkScroll(e.currentMouseCoords.y);clearInterval(e.scrollInterval),(n>0&&"down"==e.rowObject.direction||0>n&&"up"==e.rowObject.direction)&&e.setScroll(n);var i=e.findDropTargetRow(a,r);i&&("down"==e.rowObject.direction?e.rowObject.swap("after",i,e):e.rowObject.swap("before",i,e),e.restripeTable())}if(e.indentEnabled){var s=e.currentMouseCoords.x-e.dragObject.indentMousePos.x,o=Math.round(s/e.indentAmount*e.rtl),l=e.rowObject.indent(o);e.dragObject.indentMousePos.x+=e.indentAmount*l*e.rtl,e.indentCount=Math.max(e.indentCount,e.rowObject.indents)}return!1}},r.tableDrag.prototype.dropRow=function(e,r){if(null!=r.rowObject){var a=r.rowObject.element;if(1==r.rowObject.changed){if(r.updateFields(a),r.tableSettings.group.fieldClass)for(var n in r.rowObject.children)r.updateField(r.rowObject.children[n],"group");0==r.changed&&(r.changed=!0)}r.indentEnabled&&r.rowObject.removeIndentClasses(),r.oldRowElement&&t(r.oldRowElement).removeClass("drag-previous"),t(a).removeClass("drag").addClass("drag-previous"),r.oldRowElement=a,r.onDrop(),r.rowObject=null}null!=r.dragObject&&(t(".tabledrag-handle",a).removeClass("tabledrag-handle-hover"),r.dragObject=null,t("body").removeClass("drag"),clearInterval(r.scrollInterval),-1!=navigator.userAgent.indexOf("MSIE 6.")&&t("select",this.table).css("display","block"))},r.tableDrag.prototype.mouseCoords=function(t){return t.pageX||t.pageY?{x:t.pageX,y:t.pageY}:{x:t.clientX+document.body.scrollLeft-document.body.clientLeft,y:t.clientY+document.body.scrollTop-document.body.clientTop}},r.tableDrag.prototype.getMouseOffset=function(e,r){var a=t(e).offset(),n=this.mouseCoords(r);return{x:n.x-a.left,y:n.y-a.top}},r.tableDrag.prototype.findDropTargetRow=function(e,r){for(var a=t(this.table.tBodies[0].rows).not(":hidden"),n=0;n<a.length;n++){var i=a[n],s=t(i).offset().top;if(0==i.offsetHeight)var o=parseInt(i.firstChild.offsetHeight,10)/2;else var o=parseInt(i.offsetHeight,10)/2;if(r>s-o&&s+o>r){if(this.indentEnabled){for(var n in this.rowObject.group)if(this.rowObject.group[n]==i)return null}else if(i==this.rowObject.element)return null;if(!this.rowObject.isValidSwap(i))return null;for(;t(i).is(":hidden")&&t(i).prev("tr").is(":hidden");)i=t(i).prev("tr").get(0);return i}}return null},r.tableDrag.prototype.updateFields=function(t){for(var e in{group:1,weight:1,parent:1})this.updateField(t,e)},r.tableDrag.prototype.updateField=function(e,r){var a=this.rowSettings(r,e);if("self"==a.relationship||"group"==a.relationship)var n=e;else if("sibling"==a.relationship){var i=t(e).prev("tr").get(0),s=t(e).next("tr").get(0),n=e;t(i).is("."+this.tableSettings.draggableClass)&&t("."+r,i).length?this.indentEnabled?t(".indentations",i).length==t(".indentations",e)&&(n=i):n=i:t(s).is("."+this.tableSettings.draggableClass)&&t("."+r,s).length&&(this.indentEnabled?t(".indentations",s).length==t(".indentations",e)&&(n=s):n=s)}else if("parent"==a.relationship){for(var i=t(e).prev("tr");i.length&&t(".indentation",i).length>=this.rowObject.indents;)i=i.prev("tr");if(i.length)n=i[0];else{n=t(this.table).find("tr."+this.tableSettings.draggableClass+":first").get(0),n==this.rowObject.element&&(n=t(this.rowObject.group[this.rowObject.group.length-1]).next("tr."+this.tableSettings.draggableClass).get(0));var o=!0}}this.copyDragClasses(n,e,r),a=this.rowSettings(r,e),o&&(a.relationship="sibling",a.source=a.fieldClass);var l="."+a.fieldClass,d=t(l,e);if(d){var h="."+("parent"==a.relationship?a.sourceFieldClass:a.fieldClass),g=t(h,n);switch(a.action){case"depth":d.val(t(".indentation",g.closest("tr")).length);break;case"match":d.val(g.val());break;case"order":var c=this.rowObject.findSiblings(a);if(d.is("select")){var p=[];t("option",d).each(function(){p.push(this.value)});var b=p[p.length-1];t(l,c).each(function(){this.value=p.length>0?p.shift():b})}else{var u=parseInt(t(l,c[0]).val(),10)||0;t(l,c).each(function(){this.value=u,u++})}}}},r.tableDrag.prototype.copyDragClasses=function(e,r,a){var n=t("."+a,e),i=t("."+a,r);n.length&&i.length&&(i[0].className=n[0].className)},r.tableDrag.prototype.checkScroll=function(t){var e=document.documentElement,r=document.body,a=this.windowHeight=window.innerHeight||(e.clientHeight&&0!=e.clientWidth?e.clientHeight:r.offsetHeight),n=this.scrollY=document.all?e.scrollTop?e.scrollTop:r.scrollTop:window.pageYOffset?window.pageYOffset:window.scrollY,i=this.scrollSettings.trigger,s=0;return t-n>a-i?(s=i/(a+n-t),s=s>0&&i>s?s:i,s*this.scrollSettings.amount):i>t-n?(s=i/(t-n),s=s>0&&i>s?s:i,-s*this.scrollSettings.amount):void 0},r.tableDrag.prototype.setScroll=function(t){var e=this;this.scrollInterval=setInterval(function(){e.checkScroll(e.currentMouseCoords.y);var r=e.scrollY>e.table.topY,a=e.scrollY+e.windowHeight<e.table.bottomY;(t>0&&a||0>t&&r)&&window.scrollBy(0,t)},this.scrollSettings.interval)},r.tableDrag.prototype.restripeTable=function(){t("> tbody > tr."+this.tableSettings.draggableClass+":visible, > tr."+this.tableSettings.draggableClass+":visible",this.table).removeClass("odd even").filter(":odd").addClass("even").end().filter(":even").addClass("odd")},r.tableDrag.prototype.onDrag=function(){return this.$table.trigger("tabledrag:dragrow",this),null},r.tableDrag.prototype.onDrop=function(){return this.$table.trigger("tabledrag:droprow",this),null},r.tableDrag.prototype.row=function(e,r,a,n,i,s){if(this.element=e,this.method=r,this.group=[e],this.groupDepth=t(".indentation",e).length,this.changed=!1,this.table=t(e).closest("table").get(0),this.indentEnabled=a,this.maxDepth=n,this.direction="",this.draggableClass=s,this.indentEnabled){this.indents=t(".indentation",e).length,this.children=this.findChildren(i),this.group=t.merge(this.group,this.children);for(var o=0;o<this.group.length;o++)this.groupDepth=Math.max(t(".indentation",this.group[o]).length,this.groupDepth)}},r.tableDrag.prototype.row.prototype.findChildren=function(e){for(var r=this.indents,a=t(this.element,this.table).next("tr."+this.draggableClass),n=[],i=0;a.length;){var s=t(".indentation",a).length;if(!(s>r))break;i++,n.push(a[0]),e&&t(".indentation",a).each(function(e){1==i&&e==r&&t(this).addClass("tree-child-first"),e==r?t(this).addClass("tree-child"):e>r&&t(this).addClass("tree-child-horizontal")}),a=a.next("tr."+this.draggableClass)}return e&&n.length&&t(".indentation:nth-child("+(r+1)+")",n[n.length-1]).addClass("tree-child-last"),n},r.tableDrag.prototype.row.prototype.isValidSwap=function(e){if(this.indentEnabled){var r,a;if("down"==this.direction?(r=e,a=t(e).next("tr").get(0)):(r=t(e).prev("tr").get(0),a=e),this.interval=this.validIndentInterval(r,a),this.interval.min>this.interval.max)return!1}return this.table.tBodies[0].rows[0]==e&&t(e).is(":not(."+this.draggableClass+")")?!1:!0},r.tableDrag.prototype.row.prototype.swap=function(e,r){t(r)[e](this.group),this.changed=!0,this.onSwap(r)},r.tableDrag.prototype.row.prototype.validIndentInterval=function(e,r){var a,n;return a=r?t(".indentation",r).length:0,!e||t(e).is(":not(."+this.draggableClass+")")||t(this.element).is(".tabledrag-root")?n=0:(n=t(".indentation",e).length+(t(e).is(".tabledrag-leaf")?0:1),this.maxDepth&&(n=Math.min(n,this.maxDepth-(this.groupDepth-this.indents)))),{min:a,max:n}},r.tableDrag.prototype.row.prototype.indent=function(e){if(!this.interval){var a=t(this.element).prev("tr").get(0),n=t(this.group).filter(":last").next("tr").get(0);this.interval=this.validIndentInterval(a,n)}var i=this.indents+e;i=Math.max(i,this.interval.min),i=Math.min(i,this.interval.max),e=i-this.indents;for(var s=1;s<=Math.abs(e);s++)0>e?(t(".indentation:first",this.group).remove(),this.indents--):(t("td:first",this.group).prepend(r.theme("tableDragIndentation")),this.indents++);return e&&(this.changed=!0,this.groupDepth+=e,this.onIndent()),e},r.tableDrag.prototype.row.prototype.findSiblings=function(e){for(var r=[],a=["prev","next"],n=this.indents,i=0;i<a.length;i++){for(var s=t(this.element)[a[i]]();s.length&&t("."+e.target,s);){if(this.indentEnabled)var o=t(".indentation",s).length;if(this.indentEnabled&&o!=n){if(n>o)break}else r.push(s[0]);s=t(s)[a[i]]()}"prev"==a[i]&&(r.reverse(),r.push(this.element))}return r},r.tableDrag.prototype.row.prototype.removeIndentClasses=function(){for(var e in this.children)t(".indentation",this.children[e]).removeClass("tree-child").removeClass("tree-child-first").removeClass("tree-child-last").removeClass("tree-child-horizontal")},r.tableDrag.prototype.row.prototype.onIndent=function(){return null},r.tableDrag.prototype.row.prototype.onSwap=function(){return null},r.t=function(t){return t},r.theme=function(t){var e=Array.prototype.slice.apply(arguments,[1]);return(r.theme[t]||r.theme.prototype[t]).apply(this,e)},r.theme.prototype.tableDragChangedMarker=function(){return'<span class="warning tabledrag-changed">*</span>'},r.theme.prototype.tableDragIndentation=function(){return'<div class="indentation">&nbsp;</div>'}}(jQuery);
